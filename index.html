<!DOCTYPE html>
<html>
    <head>
        <title>Red Cross Hackathon</title>
        <meta charset = "utf-8">
        <meta name = "description" content = "Red Cross">
        <meta name = "viewport" content = "width = device-width, initial-scale = 1">
        <link rel = "stylesheet" href = "src/style.css">
        
        <script type = 'text/javascript' src = "jq.js"></script>
        
        <script type = 'text/javascript'>
            const key = 'ff9ba92f56ed4ed0b1edf0bc8a23b311'
            var position
            var address
            var destAddress

            function getLoc() {
                navigator.geolocation.getCurrentPosition((pos) => {
                    position = pos.coords
                    getAddress();
                })
            }

            function getAddress() {
                fetch(`https://api.geoapify.com/v1/geocode/reverse?lat=${position.latitude}&lon=${position.longitude}&apiKey=${key}`)
                .then(response => response.json())
                .then(result => {
                    if (result.features.length) {
                        console.log(result.features[0].properties.postcode)
                        getLocations(result.features[0].properties.postcode)
                        address = result.features[0].properties.formatted;
                        console.log(address)
                    } else {
                        console.log("No address found");
                    }
                })
            }

            function getLocations(zipCode) {
                fetch("https://www.redcross.org/api/lookup/v1/region-mappings/" + zipCode +"?type\x3dRCO", { mode: "no-cors" })
                .then(response => response.json())
                .then(result => {
                    if (result[0].regionCode) {
                        fetch("https://www.redcross.org/bin/location-search.regionCode" + toString(result[0].regionCode) +"\x3d.json")
                        .then(response => response.json())
                        .then(result => {
                            if (result.regionStreet) {
                                destAddress = `${result.regionStreet}, ${result.regionCity}, ${result.regionState} ${result.regionZip}`
                                console.log(destAddress)
                            } else {
                                console.log("No address found")
                            }
                        })
                        redirect()
                    } else {
                        console.log("No address found");
                    }   
                })
            }

            function redirect() {
                window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(address)}&destination=${encodeURIComponent(destAddress)}`)
            }

            function get() {
                getLoc()
            }
        </script>
    </head>

    <body>
        <input type = "button" onClick = "get()" value = "Search" /><br/>
        <div id = "output"></div>
    </body>
</html>